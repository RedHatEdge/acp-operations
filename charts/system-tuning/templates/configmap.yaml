{{- with .Values.networkTuning.interfaceMTUs }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wait-for-mcp-script
  namespace: openshift-config
  annotations:
    argocd.argoproj.io/sync-wave: "1"
data:
  wait-for-mcp.sh: |
    #!/bin/bash
    set -e
    check_mcp_status() {
      local updating_count
      updating_count=$(oc get machineconfigpools -o jsonpath='{range .items[*]}{.metadata.name} {.status.conditions[?(@.type=="Updating")].status}{"\n"}{end}' | grep " True" | wc -l)

      if [[ "$updating_count" -eq 0 ]]; then
        return 0
      else
        echo "$updating_count MachineConfigPools still updating..."
        return 1
      fi
    }

    echo "Waiting for all MachineConfigPools to finish updating..."

    while ! check_mcp_status; do
      sleep 60
    done

    echo "All MachineConfigPools have finished updating."
{{ end }}